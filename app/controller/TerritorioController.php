<?php

namespace app\controller;

use app\middleware\Admin;
use app\model\Municipio;
use app\model\Parroquia;

class TerritorioController extends Admin
{
    public string $TITTLE = 'Territorio';
    public string $MODULO = 'territorio.index';

    public $links;
    public $rows;
    public $limit;
    public $totalRows;
    public $offset;
    public $keyword;

    public function isAdmin()
    {
        parent::isAdmin(); // TODO: Change the autogenerated stub
        if (!validarPermisos($this->MODULO)) {
            header('location: ' . ROOT_PATH . 'admin\\');
        }
    }

    public function index(
        $table = 'municipios',
        $limit = null,
        $totalRows = null,
        $offset = null,
    )
    {
        if ($table == 'municipios') {
            $baseURL = '_request/MunicipiosRequest.php';
            $tableID = 'tabla_municipios';
            $opcion = 'paginate_municipio';
            $contentDiv = 'dataContainerMunicipio';
            $model = new Municipio();
        }else{
            $baseURL = '_request/ParroquiasRequest.php';
            $tableID = 'tabla_parroquias';
            $opcion = 'paginate_parroquias';
            $contentDiv = 'dataContainerParroquia';
            $model = new Parroquia();
        }


        if (is_null($limit)) {
            $this->limit = numRowsPaginate();
        } else {
            $this->limit = $limit;
        }
        if (is_null($totalRows)) {
            $this->totalRows = $model->count();
        } else {
            $this->totalRows = $totalRows;
        }
        $this->offset = $offset;

        $this->links = paginate($baseURL, $tableID, $this->limit, $this->totalRows, $this->offset, $opcion, $contentDiv)->createLinks();
        $this->rows = $model->paginate($this->limit, $this->offset);
    }

    public function store($table, $nombre, $mini, $asignacion, $municipio = null)
    {
        $hoy = date('Y-m-d');

        if ($table == "municipio"){
            $model = new Municipio();

            $existeMunicipio = $model->existe('nombre', '=', $nombre, null);
            $existeMini = $model->existe('mini', '=', $mini, null);

            if (!$existeMunicipio && !$existeMini) {

                $data = [
                    $nombre,
                    $mini,
                    $asignacion,
                    $hoy
                ];

                $model->save($data);
                $municipios = $model->first('nombre', '=', $nombre);
                $response = crearResponse(
                    null,
                    true,
                    'Municipio Creado Exitosamente.',
                    "Municipio Creado " . $nombre
                );
                //datos extras para el $response
                $response['id'] = $municipios['id'];
                $response['item'] = '<p> ' . $model->count() . '. </p>';
                $response['nombre'] = '<p class="text-uppercase">'.$municipios['nombre'].'</p>';
                $response['mini'] = '<p class="text-uppercase">'.$municipios['mini'].'</p>';
                $response['asignacion'] = '<p class="text-right">'.formatoMillares($municipios['familias'], 0).'</p>';
                $response['parroquias'] = formatoMillares($municipios['parroquias'], 0);
                $response['nuevo'] = true;
                $response['total'] = $model->count();
                $response['btn_editar'] = validarPermisos('municipios.edit');
                $response['btn_eliminar'] = validarPermisos('municipios.destroy');
                $response['btn_estatus'] = validarPermisos('municipios.estatus');

            } else {

                $response = crearResponse(
                    'nombre_duplicado',
                    false,
                    'Nombre Duplicado.',
                    'El nombre ya esta registrado.',
                    'warning'
                );

                //datos extras para el $response

                if ($existeMunicipio) {
                    $response['error_municipio'] = true;
                    $response['message_municipio'] = 'El nombre ya esta registrado.';
                } else {
                    $response['error_municipio'] = false;
                }

                if ($existeMini) {
                    $response['error_mini'] = true;
                    $response['message_mini'] = 'La abreviatura ya esta registrada.';
                } else {
                    $response['error_mini'] = false;
                }

            }


        }else{
            $model = new Parroquia();
            $modelMunicipio = new Municipio();
            if (empty($asignacion)) {
                if ($asignacion != 0) {
                    $asignacion = null;
                }
                $asignacion_sql = "";
            } else {
                $asignacion_sql = "AND `familias` = '$asignacion'";
            }

            $existeNombre = $model->existe('nombre', '=', $nombre, null);
            $existeMini = $model->existe('mini', '=', $mini, null);

            $getMunicipio = $modelMunicipio->find($municipio);
            $asignacionMax = $getMunicipio['familias'];
            $getParroquias = $model->getList('municipios_id', '=', $municipio);
            $suma = 0;

            foreach ($getParroquias as $getParroquia){
                $suma = $suma + $getParroquia['familias'];
            }

            $asignacionCargar = $suma + $asignacion;

            if (!$existeNombre && !$existeMini && $asignacionMax >= $asignacionCargar) {
                //se guarda
                $data = [
                    $nombre,
                    $mini,
                    $municipio,
                    $asignacion,
                    $hoy
                ];

                $model->save($data);
                $parroquias = $model->existe('nombre', '=', $nombre, null);
                $municipio = $modelMunicipio->find($parroquias['municipios_id']);

                //incremento contador de parroquis al municipio
                $count = $municipio['parroquias'] + 1;
                $modelMunicipio->update($municipio['id'], 'parroquias', $count);

                $response = crearResponse(
                    null,
                    true,
                    'Parroquia Creada Exitosamente.',
                    "Parroquia Creado exitosamente" . $nombre
                );
                //datos extras para el $response
                $response['id'] = $parroquias['id'];
                $response['item'] = '<p class="text-center">' . $model->count() . '.</p>';
                $response['municipio'] = $municipio['nombre'];
                $response['municipios_id'] = $municipio['id'];
                $response['municipio_parroquias'] = $count;
                $response['parroquia'] = '<p class="text-uppercase">'.$parroquias['nombre'].'</p>';
                $response['mini'] = '<p class="text-center text-uppercase">'.$parroquias['mini'].'</p>';
                $response['asignacion'] = '<p class="text-right">'.formatoMillares($parroquias['familias'], 0).'</p>';
                $response['nuevo'] = true;
                $response['total'] = $model->count();
                $response['btn_editar'] = validarPermisos('parroquias.edit');
                $response['btn_eliminar'] = validarPermisos('parroquias.destroy');
                $response['btn_estatus'] = validarPermisos('parroquias.estatus');

            } else {
                //la parroquia ya existe

                //datos extras para el $response

                if ($existeNombre) {
                    $response = crearResponse(
                        'nombre_duplicado',
                        false,
                        'Nombre Duplicado.',
                        'La parroquia ya esta registrada.',
                        'warning'
                    );
                    $response['error_nombre'] = true;
                    $response['message_nombre'] = 'El nombre de la parroquia ya esta registrado.';
                } else {
                    $response['error_nombre'] = false;
                }

                if ($existeMini) {
                    $response = crearResponse(
                        'nombre_duplicado',
                        false,
                        'Abreviatura Duplicada.',
                        'La parroquia ya esta registrada.',
                        'warning'
                    );
                    $response['error_mini'] = true;
                    $response['message_mini'] = 'La abreviatura ya esta registrada.';
                } else {
                    $response['error_mini'] = false;
                }

                if ($asignacionMax < $asignacionCargar){
                    $response = crearResponse(
                        'nombre_duplicado',
                        false,
                        'Revisar Asignacion.',
                        'La parroquia ya esta registrada.',
                        'warning'
                    );
                    $response['error_asignacion'] = true;
                    $response['message_asignacion'] = 'La AsignaciÃ³n de las parroquias no debe ser mayor a la del municipio.';
                }else{
                    $response['error_asignacion'] = false;
                }

            }

        }

        return $response;
    }

    public function edit($table, $id)
    {
        if ($table == "municipio"){
            $model = new Municipio();
            $municipio = $model->find($id);
            $response = crearResponse(
                null,
                true,
                'Editar Muncipio.',
                "Municipio " . $municipio['nombre'],
                'success',
                false,
                true
            );
            //datos extras para el $response
            $response['id'] = $municipio['id'];
            $response['nombre'] = $municipio['nombre'];
            $response['mini'] = $municipio['mini'];
            $response['asignacion'] = $municipio['familias'];
        }else{
            $model = new Parroquia();
            $parroquia = $model->find($id);
            $response = crearResponse(
                null,
                true,
                'Editar Parroquia.',
                "parroquia " . $parroquia['nombre'],
                'success',
                false,
                true
            );
            //datos extras para el $response
            $response['id'] = $parroquia['id'];
            $response['municipios'] = $parroquia['municipios_id'];
            $response['parroquia'] = $parroquia['nombre'];
            $response['mini'] = $parroquia['mini'];
            $response['asignacion'] = $parroquia['familias'];
        }

        return $response;
    }




    public function getMunicipio($id)
    {
        $model = new Municipio();
        $municipio = $model->find($id);
        return $municipio['mini'];

    }


}